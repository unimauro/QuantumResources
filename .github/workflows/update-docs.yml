name: Update GitHub Pages

on:
  push:
    branches: [ master, main ]
    paths:
      - 'README.md'
      - 'QuantumResources.ipynb'
      - 'update_docs.py'
  workflow_dispatch:
  
  # Ejecutar automÃ¡ticamente cada semana
  schedule:
    - cron: '0 0 * * 0'  # Domingos a medianoche UTC

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Instalar dependencias bÃ¡sicas para el parser
        pip install nbformat jupyter
    
    - name: ğŸ” Check for changes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E "(README\.md|QuantumResources\.ipynb|update_docs\.py)"; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸš€ Update documentation
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      run: |
        echo "ğŸ”„ Actualizando documentaciÃ³n..."
        python update_docs.py --verbose
        
        # Verificar que los archivos fueron generados correctamente
        if [ ! -f "docs/index.html" ]; then
          echo "âŒ Error: index.html no fue generado"
          exit 1
        fi
        
        if [ ! -f "docs/data.json" ]; then
          echo "âŒ Error: data.json no fue generado" 
          exit 1
        fi
        
        echo "âœ… DocumentaciÃ³n actualizada correctamente"
    
    - name: ğŸ“Š Show statistics
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      run: |
        echo "ğŸ“ˆ EstadÃ­sticas del sitio:"
        if [ -f "docs/data.json" ]; then
          python3 -c "
        import json
        with open('docs/data.json', 'r') as f:
            data = json.load(f)
        print('ğŸ“š Libros:', data.get('total_books', 0))
        print('ğŸ§  Recursos QML:', data.get('total_qml_resources', 0))
        print('ğŸ•’ Ãšltima actualizaciÃ³n:', data.get('last_update', 'N/A'))
        "
        fi
    
    - name: ğŸŒ Setup Pages
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      uses: actions/configure-pages@v3
    
    - name: ğŸ“ Upload artifact
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      uses: actions/upload-pages-artifact@v2
      with:
        path: './docs'
    
    - name: ğŸš€ Deploy to GitHub Pages
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: ğŸ“ Commit updated files
      if: steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Agregar archivos modificados
        git add docs/ || true
        
        # Commit solo si hay cambios
        if git diff --staged --quiet; then
          echo "No hay cambios para commitear"
        else
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica de la documentaciÃ³n
          
          - Libros actualizados desde README.md
          - Recursos QML procesados
          - Fecha: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          [skip ci]" || echo "Commit fallÃ³, posiblemente no hay cambios"
          
          git push || echo "Push fallÃ³, posiblemente no hay cambios"
        fi
    
    - name: ğŸ‰ Success notification
      if: success() && (steps.changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
      run: |
        echo "âœ… Â¡Despliegue exitoso!"
        echo "ğŸŒ Tu sitio estÃ¡ disponible en: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "ğŸ“Š Revisa las estadÃ­sticas en el log anterior"
    
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ El despliegue fallÃ³. Revisa los logs para mÃ¡s detalles."
        echo "ğŸ” Pasos para debuggear:"
        echo "   1. Revisa el formato del README.md"
        echo "   2. Verifica que la carpeta docs/ existe"
        echo "   3. AsegÃºrate de que el script update_docs.py funciona localmente" 